<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>🧪 Test Results - <%= @test_result.test_timestamp.strftime("%m/%d/%Y at %I:%M %p") %></h1>
        <%= link_to "← Back to Sandbox", sandbox_path, class: "btn btn-secondary" %>
      </div>
    </div>
  </div>

  <!-- Test Summary -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Total Tests</h5>
          <h2 class="text-primary"><%= @test_result.total_tests %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Passed</h5>
          <h2 class="text-success"><%= @test_result.passed_tests %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Failed</h5>
          <h2 class="text-danger"><%= @test_result.failed_tests %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Success Rate</h5>
          <h2 class="text-<%= @test_result.success_rate >= 80 ? 'success' : 'warning' %>">
            <%= @test_result.success_rate.round(1) %>%
          </h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Overall Status -->
  <div class="row mb-4">
    <div class="col-12">
      <% if @test_result.success_rate == 100 %>
        <div class="alert alert-success text-center">
          <h4>✅ All Tests Passed!</h4>
          <p class="mb-0">Your trading system is working perfectly in sandbox mode.</p>
        </div>
      <% elsif @test_result.success_rate >= 80 %>
        <div class="alert alert-warning text-center">
          <h4>⚠️ Most Tests Passed</h4>
          <p class="mb-0">System is mostly functional but some issues were detected.</p>
        </div>
      <% else %>
        <div class="alert alert-danger text-center">
          <h4>❌ Multiple Test Failures</h4>
          <p class="mb-0">System has significant issues that need attention.</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Detailed Test Results -->
  <% if @test_data['tests'] %>
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Detailed Test Results</h5>
          </div>
          <div class="card-body">
            <% @test_data['tests'].each do |test_name, test_result| %>
              <div class="card mb-3">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                      <% case test_name.to_s %>
                      <% when 'authentication' %>
                        🔐 API Authentication
                      <% when 'market_data' %>
                        📊 Market Data Retrieval
                      <% when 'scanner' %>
                        🔍 Scanner Functionality
                      <% when 'risk_management' %>
                        🛡️ Risk Management
                      <% when 'order_placement' %>
                        📋 Order Placement
                      <% when 'execution_pipeline' %>
                        ⚡ Execution Pipeline
                      <% else %>
                        🔧 <%= test_name.to_s.humanize %>
                      <% end %>
                    </h6>
                    <span class="badge bg-<%= test_result['status'] == 'PASS' ? 'success' : 'danger' %> fs-6">
                      <%= test_result['status'] == 'PASS' ? '✅ PASS' : '❌ FAIL' %>
                    </span>
                  </div>
                </div>
                <div class="card-body">
                  <p class="mb-2"><strong>Result:</strong> <%= test_result['message'] %></p>
                  
                  <% if test_result['error'] %>
                    <div class="alert alert-danger mb-2">
                      <strong>Error:</strong> <%= test_result['error'] %>
                    </div>
                  <% end %>
                  
                  <% if test_result['data'] || test_result['orders'] || test_result['sample_trade'] %>
                    <details class="mt-2">
                      <summary class="btn btn-outline-info btn-sm">Show Details</summary>
                      <div class="mt-2">
                        <pre class="bg-light p-2 rounded"><code><%= JSON.pretty_generate(
                          test_result.except('status', 'message', 'error')
                        ) %></code></pre>
                      </div>
                    </details>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Error Information -->
  <% if @test_data['error'] %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card border-danger">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">❌ Test Suite Error</h5>
          </div>
          <div class="card-body">
            <p><strong>Error:</strong> <%= @test_data['error'] %></p>
            <% if @test_data['backtrace'] %>
              <details>
                <summary>Stack Trace</summary>
                <pre class="mt-2"><%= @test_data['backtrace'].join("\n") %></pre>
              </details>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Summary Information -->
  <% if @test_data['summary'] %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">📈 Test Summary</h5>
          </div>
          <div class="card-body">
            <dl class="row">
              <dt class="col-sm-3">Environment:</dt>
              <dd class="col-sm-9"><%= Rails.env.upcase %></dd>
              
              <dt class="col-sm-3">Test Duration:</dt>
              <dd class="col-sm-9">~30 seconds</dd>
              
              <dt class="col-sm-3">Overall Status:</dt>
              <dd class="col-sm-9">
                <span class="badge bg-<%= @test_data['summary']['overall_status'] == 'ALL_PASS' ? 'success' : 'warning' %>">
                  <%= @test_data['summary']['overall_status'] %>
                </span>
              </dd>
              
              <dt class="col-sm-3">User:</dt>
              <dd class="col-sm-9"><%= @test_result.user.full_name %></dd>
              
              <dt class="col-sm-3">API Endpoint:</dt>
              <dd class="col-sm-9"><code><%= ENV['TASTYTRADE_API_URL'] %></code></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>